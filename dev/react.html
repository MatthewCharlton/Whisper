<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Whisper with React</title>
</head>

<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
  <script src="../src/clientSide/index.js"></script>

  <script type="text/babel">
  function whisperLink(WrappedComponent) {
    return class extends React.Component {
      constructor(props) {
        super(props)
        this.state = {}
      }

      componentDidMount() {
        Whisper.get(ReactDOM.findDOMNode(this), (e) => { this.setState(e.detail) })
      }

      whisperSet(object) {
        Whisper.set(object)
      }

      render() {
        return <WrappedComponent data={this.state} whisperSet={this.whisperSet} {...this.props} />
      }
    }
  }

    class App extends React.Component {
      constructor(props) {
        super(props)
      }

      handleChange = (e) => {
        const { value} = e.target
        this.props.whisperSet({ name: value })
        console.log(Whisper)
      }

        render() {
            const { name } = this.props.data
            console.log('render')
            return (
              <div>
                <p>Hello {name}</p>
                <input onChange={this.handleChange} />
              </div>
              );
        }
    }

    class Blah extends React.Component {
      constructor(props) {
        super(props)
      }

      handleChange = (e) => {
        const { value} = e.target
        this.props.whisperSet({ blah: value })
      }

        render() {
            const { blah, name } = this.props.data
            return (
              <div>
                <p>{name} - Blah Blah {blah}</p>
                <input onChange={this.handleChange} />
              </div>
              );
        }
    }

    class Blah2 extends React.Component {
      constructor(props) {
        super(props)
      }

      componentDidMount() {
        this.interval = setInterval(() => this.props.whisperSet({ timer: this.props.data.timer + 1 || 0 }), 1000)
      }

       componentWillUnmount() {
          clearInterval(this.interval);
        }

      handleChange = (e) => {
        const { value} = e.target
        this.props.whisperSet({ blah2: value })
      }

      render() {
          const { blah2, timer } = this.props.data
         
          return (
            <div>
              <p>{blah2} {timer}</p>
              <input onChange={this.handleChange} />
            </div>
            );
      }
    }

    const LinkedApp = whisperLink(App)
    const LinkedBlah = whisperLink(Blah)
    const LinkedBlah2 = whisperLink(Blah2)

    ReactDOM.render(
      <div>
        <LinkedApp />
        <LinkedBlah />
        <LinkedBlah2 />
      </div>,
        document.getElementById('root')
    );
</script>
</body>

</html>